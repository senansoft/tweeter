<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <title>Ù„ÙˆØ­Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¹Ø§Øª</title>
    <style>
        :root {
            --am-color: #0d6efd;
            --pm-color: #6610f2;
        }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn { border-radius: 50px; padding: 10px 24px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ø¨ÙƒØ© */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
        }
        .status-slot {
            aspect-ratio: 1/1.2;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #fff;
        }
        .slot-filled {
            background-color: #d1e7dd;
            color: #0f5132;
            border-color: #198754;
        }
        .slot-empty {
            background-color: #f8f9fa;
            color: #adb5bd;
            border-color: #dee2e6;
            border-style: dashed;
        }
        .status-slot:hover {
            transform: translateY(-3px);
            border-color: #000;
        }
        .active-slot {
            border-color: #000 !important;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.1);
        }
        .slot-time { font-weight: bold; font-size: 1.1rem; line-height: 1; }
        .slot-ampm { font-size: 0.7rem; font-weight: bold; margin-bottom: 4px; }
        
        .am-text { color: var(--am-color); }
        .pm-text { color: var(--pm-color); }

        /* Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙˆÙŠØªØ± */
        .tweet-preview { border: 1px solid #eff3f4; border-radius: 16px; }
        .tweet-avatar { width: 40px; height: 40px; background: #cfd9de; border-radius: 50%; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ ğŸ•’</h2>
            <span class="badge bg-primary rounded-pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØºØ±ÙŠØ¯Ø§Øª: {{ tweets.count }}</span>
        </div>

        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="status-grid">
                    {% for i in "x"|rjust:"24" %}
                        {% with hour=forloop.counter0 %}
                            <div class="status-slot slot-empty" 
                                 id="slot-{{ hour }}" 
                                 onclick="selectHour({{ hour }})">
                                <span class="slot-ampm {% if hour < 12 %}am-text{% else %}pm-text{% endif %}">
                                    {% if hour < 12 %}AM{% else %}PM{% endif %}
                                </span>
                                <span class="slot-time">
                                    {% if hour == 0 %}12{% elif hour > 12 %}{{ hour|add:"-12" }}{% else %}{{ hour }}{% endif %}
                                </span>
                                <i class="bi bi-plus-lg small mt-1"></i>
                            </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 id="form-title" class="fw-bold m-0">Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h5>
                        <div id="delete-area" style="display: none;">
                            <button type="button" class="btn btn-sm btn-danger" onclick="deletePost()">
                                <i class="bi bi-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                    
                    <form id="main-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="current-post-id">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
                            {{ form.content }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©</label>
                            {{ form.scheduled_time }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold" id="submitBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
                        <button type="button" class="btn btn-link w-100 text-decoration-none text-muted mt-2" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="p-3 tweet-preview bg-white shadow-sm">
                    <div class="d-flex">
                        <div class="tweet-avatar me-3"></div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ request.user.username }} <i class="bi bi-patch-check-fill text-primary"></i></div>
                            <div class="text-muted small">@{{ request.user.username }}</div>
                            <div class="mt-3 fs-5" id="preview-text" style="white-space: pre-wrap;">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¹Ø©...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="data-json" type="application/json">
        [
            {% for t in tweets %}
            {
                "id": "{{ t.pk }}",
                "hour": "{{ t.scheduled_time|date:'H' }}",
                "content": "{{ t.content|escapejs }}",
                "full_time": "{{ t.scheduled_time|date:'Y-m-d\TH:i' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const tweetsData = JSON.parse(document.getElementById('data-json').textContent);

        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ù…ØªÙ„Ø¦Ø© Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        function highlightFilledSlots() {
            tweetsData.forEach(t => {
                const hourInt = parseInt(t.hour);
                $(`#slot-${hourInt}`).removeClass('slot-empty').addClass('slot-filled');
                $(`#slot-${hourInt} i`).removeClass('bi-plus-lg').addClass('bi-check-circle-fill');
            });
        }

        function selectHour(h) {
            $('.status-slot').removeClass('active-slot');
            $(`#slot-${h}`).addClass('active-slot');

            // Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ù€ Input ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const hourStr = String(h).padStart(2, '0');
            $('input[type="datetime-local"]').val(`${dateStr}T${hourStr}:00`);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ø­Ø¬ÙˆØ²Ø©
            const post = tweetsData.find(t => parseInt(t.hour) === h);
            
            if (post) {
                $('#form-title').text('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± âœï¸');
                $('textarea').val(post.content);
                $('#preview-text').text(post.content);
                $('#current-post-id').val(post.id);
                $('#delete-area').show();
                $('#submitBtn').text('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ±');
                // ØªØºÙŠÙŠØ± Ø§Ù„Ù€ action Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„ÙŠÙƒÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ (Ø­Ø³Ø¨ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù€ views Ù„Ø¯ÙŠÙƒ)
                $('#main-form').attr('action', `/edit/${post.id}/`);
            } else {
                resetForm(false); // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                $('#main-form').attr('action', ''); 
            }
        }

        function resetForm(fullReset = true) {
            $('#form-title').text('Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯');
            $('textarea').val('');
            $('#preview-text').text('Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©...');
            $('#delete-area').hide();
            $('#submitBtn').text('Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±');
            if(fullReset) $('.status-slot').removeClass('active-slot');
        }

        function deletePost() {
            const id = $('#current-post-id').val();
            if(id && confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ')) {
                window.location.href = `/delete/${id}/`;
            }
        }

        $(document).ready(function() {
            highlightFilledSlots();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ©
            $('textarea').on('input', function() {
                $('#preview-text').text($(this).val() || 'Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©...');
            });
        });
    </script>
</body>
</html>